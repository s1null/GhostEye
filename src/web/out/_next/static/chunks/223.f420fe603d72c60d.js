"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[223],{223:function(t,r,n){n.r(r),n.d(r,{Terminal:function(){return b}});var o=n(7437),a=n(29),l=n.n(a),i=n(2265),c=n(9486),s=n(5896),d=n(1447),u=n(9604),m=n(6070);n(7489);let f=()=>"",w="terminal_auth_token",v={},h="utf-8";function b(t){let{id:r,config:n,onClose:a}=t,b=(0,i.useRef)(null),[p,y]=(0,i.useState)(!1),[x,g]=(0,i.useState)(null),{ip:k,port:S}=n,[E,N]=(0,i.useState)(!1),[T,j]=(0,i.useState)(!1),C=(0,i.useRef)(""),[O,W]=(0,i.useState)("calc(100% - 40px)"),A=(0,i.useRef)(null),L=(0,i.useRef)(0),z=(0,i.useRef)(null),D=(0,i.useRef)(!1),I=(0,i.useRef)(null),[P,F]=(0,i.useState)(!1);return(0,i.useEffect)(()=>{let t=localStorage.getItem(w);t&&(g(t),y(!0))},[]),(0,i.useEffect)(()=>{let t=t=>{var n,o,a,l;let{terminalId:i,command:c}=t.detail;if(i===r&&(null===(o=v[r])||void 0===o?void 0:null===(n=o.websocket)||void 0===n?void 0:n.readyState)===WebSocket.OPEN){let t=c.endsWith("\n")?c:c+"\n";null===(a=v[r].websocket)||void 0===a||a.send(t),null===(l=v[r].terminal)||void 0===l||l.write("\r\n$ ".concat(c,"\r\n"))}};window.addEventListener("terminal-command",t);let n=t=>{let{terminalId:n}=t.detail;if(n===r){var o,a,l,i;if((null===(a=v[r])||void 0===a?void 0:null===(o=a.websocket)||void 0===o?void 0:o.readyState)===WebSocket.OPEN)try{let t=JSON.stringify({type:"close",data:{terminalId:r}});null===(l=v[r].websocket)||void 0===l||l.send(t),null===(i=v[r].terminal)||void 0===i||i.write("\r\nTerminal closing...\r\n"),setTimeout(()=>{var t,n;(null===(t=v[r])||void 0===t?void 0:t.websocket)&&(null===(n=v[r].websocket)||void 0===n||n.close())},100)}catch(t){}}};return window.addEventListener("terminal-close",n),()=>{window.removeEventListener("terminal-command",t),window.removeEventListener("terminal-close",n)}},[r]),(0,i.useEffect)(()=>{var t;if(!b.current)return;if(null===(t=v[r])||void 0===t?void 0:t.terminal){let{terminal:t,fitAddon:n}=v[r];if(t&&n)try{t.open(b.current),setTimeout(()=>{try{n.fit()}catch(t){console.error("Error fitting terminal:",t)}},100);return}catch(t){console.error("Error reopening terminal:",t),delete v[r]}}let n=new c.Terminal({cursorBlink:!0,fontSize:14,fontFamily:"Menlo, Monaco, Consolas, monospace",theme:{background:"#18181B",foreground:"#FAFAFA",cursor:"#FAFAFA",selectionBackground:"rgba(255, 255, 255, 0.3)"},allowTransparency:!0,scrollback:1e4,convertEol:!0,screenReaderMode:!0,disableStdin:!1,allowProposedApi:!0,rightClickSelectsWord:!0}),o=new s.FitAddon,a=new d.WebLinksAddon;n.loadAddon(o),n.loadAddon(a),n.open(b.current);try{let t=new u.WebglAddon;n.loadAddon(t),t.onContextLoss(()=>{console.warn("WebGL context lost, falling back to canvas renderer"),t.dispose()})}catch(t){console.warn("WebGL not available, falling back to canvas renderer:",t)}setTimeout(()=>{try{o.fit();let{cols:t,rows:r}=n}catch(t){console.error("Error fitting terminal:",t)}},100),setTimeout(()=>{try{o.fit()}catch(t){console.error("Error fitting terminal after delay:",t)}},500),v[r]={terminal:n,websocket:null,fitAddon:o,dataListeners:[]};let l=()=>{try{if(!o)return;if(b.current&&null!==b.current.offsetParent){var t,a,l;o.fit();let{cols:i,rows:c}=n;(null===(a=v[r])||void 0===a?void 0:null===(t=a.websocket)||void 0===t?void 0:t.readyState)===WebSocket.OPEN&&(null===(l=v[r].websocket)||void 0===l||l.send(JSON.stringify({type:"resize",data:{cols:i,rows:c}})))}}catch(t){console.error("Error handling resize:",t)}};window.addEventListener("resize",l);let i=new ResizeObserver(()=>{setTimeout(l,0)});return b.current&&i.observe(b.current),()=>{var t,o;if(window.removeEventListener("resize",l),i&&(b.current&&i.unobserve(b.current),i.disconnect()),n&&n.element&&(null===(t=b.current)||void 0===t?void 0:t.contains(n.element)))try{(null===(o=v[r])||void 0===o?void 0:o.dataListeners)&&(v[r].dataListeners.forEach(t=>{t&&"function"==typeof t.dispose&&t.dispose()}),v[r].dataListeners=[]),n.element.remove()}catch(t){console.error("Error removing terminal element:",t)}}},[r]),(0,i.useEffect)(()=>{let t=setTimeout(()=>{let t=()=>{var t,o,a,l;if(D.current)return;D.current=!0;let i=localStorage.getItem(w),c=f().replace(/^http:\/\//,"")||(k&&S?"".concat(k,":").concat(S):window.location.host),s="https:"===window.location.protocol?"wss://":"ws://",d=i?"".concat(s).concat(c,"/ws?token=").concat(i,"&terminalId=").concat(r):"".concat(s).concat(c,"/ws?terminalId=").concat(r);if((null===(o=v[r])||void 0===o?void 0:null===(t=o.websocket)||void 0===t?void 0:t.readyState)===WebSocket.OPEN){N(!0),D.current=!1;return}if(null===(a=v[r])||void 0===a?void 0:a.websocket)try{let t=v[r].websocket;t&&(t.onclose=null,t.onerror=null,t.onmessage=null,t.onopen=null,(t.readyState===WebSocket.OPEN||t.readyState===WebSocket.CONNECTING)&&t.close()),v[r].websocket=null}catch(t){console.error("Error closing existing websocket:",t)}let u=null===(l=v[r])||void 0===l?void 0:l.terminal;if(!u){D.current=!1;return}u.clear(),u.write("Connecting to terminal...(Attempt ".concat(L.current+1,"/").concat(5,")\r\n"));let m=new WebSocket(d);v[r].websocket=m,j(!1),m.binaryType="arraybuffer";let b=setTimeout(()=>{m.readyState!==WebSocket.OPEN&&(m.close(3001,"连接超时"),D.current=!1)},1e4);m.onopen=()=>{clearTimeout(b),N(!0),j(!1),L.current=0,D.current=!1;try{m.send(JSON.stringify({type:"resize",data:{cols:u.cols,rows:u.rows}}))}catch(t){console.error("Error sending terminal size:",t)}},m.onmessage=t=>{try{if("string"==typeof t.data)try{let n=JSON.parse(t.data);if("auth"===n.type)n.success&&(y(!0),n.token&&(g(n.token),localStorage.setItem(w,n.token)));else if("heartbeat"===n.type);else if("output"===n.type&&n.terminalId===r)try{if(n.data){let t=atob(n.data),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);let o=new TextDecoder(h).decode(r);u.write(o)}}catch(t){}else if(n.terminalId===r&&n.data)try{let t=atob(n.data),r=new Uint8Array(t.length);for(let n=0;n<t.length;n++)r[n]=t.charCodeAt(n);let o=new TextDecoder(h).decode(r);u.write(o)}catch(t){u.write(n.data)}}catch(r){u.write(t.data)}else if(t.data instanceof ArrayBuffer){let r=new TextDecoder(h).decode(t.data);u.write(r)}}catch(t){console.error("Error handling websocket message:",t)}},m.onclose=t=>{if(N(!1),1e3===t.code||1001===t.code){u.write("\r\n\uD83D\uDFE0 Connection closed normally\r\n"),D.current=!1;return}u.write("\r\n\uD83D\uDD34 Connection lost (Code: ".concat(t.code,")\r\n")),Date.now()-new Date().getTime()<5e3?setTimeout(()=>{n()},5e3):n()},m.onerror=t=>{if(N(!1),j(!0),console.error("Error handling websocket message:",e),u.write("\r\n\uD83D\uDD34 Connection error\r\n"),m.readyState===WebSocket.OPEN||m.readyState===WebSocket.CONNECTING)try{m.close(3004,"连接错误")}catch(t){}else n()};let p=u.onData(t=>{if(m.readyState===WebSocket.OPEN)try{let r=32>t.charCodeAt(0)||127===t.charCodeAt(0);if("\r"===t){let t=C.current+"\n",r=new TextEncoder().encode(t);m.send(r),u.write("\r\n"),C.current=""}else if("\x7f"===t)C.current.length>0&&(C.current=C.current.slice(0,-1),u.write("\b \b"));else if(r){let r=new TextEncoder().encode(t);m.send(r)}else C.current+=t,u.write(t)}catch(t){console.error("Error sending data to websocket:",t),u.write("\r\nFailed to send data\r\n"),m.readyState!==WebSocket.OPEN&&(u.write("\r\nConnection lost, attempting to reconnect...\r\n"),n())}else m.readyState===WebSocket.CONNECTING?u.write("\r\nConnecting, please wait...\r\n"):(u.write("\r\nConnection lost, attempting to reconnect...\r\n"),n())});return v[r].dataListeners=[p],I.current&&clearInterval(I.current),I.current=setInterval(()=>{if(m.readyState===WebSocket.OPEN)try{m.send(JSON.stringify({type:"heartbeat",data:"ping"}))}catch(t){if(m.readyState===WebSocket.OPEN)try{m.close(3005,"心跳发送失败")}catch(t){}}},5e3),()=>{var t;if(I.current&&(clearInterval(I.current),I.current=null),m.readyState===WebSocket.OPEN||m.readyState===WebSocket.CONNECTING)try{m.close()}catch(t){console.error("Error closing websocket:",t)}(null===(t=v[r])||void 0===t?void 0:t.dataListeners)&&(v[r].dataListeners.forEach(t=>{t&&"function"==typeof t.dispose&&t.dispose()}),v[r].dataListeners=[]),v[r].websocket=null}},n=()=>{if(z.current&&(clearTimeout(z.current),z.current=null),L.current>=5){var n;let t=null===(n=v[r])||void 0===n?void 0:n.terminal;t&&t.write("\r\n⚠️ Maximum reconnection attempts reached (".concat(5,"), please press Enter to retry manually\r\n")),D.current=!1;return}L.current++;let o=Math.min(2e3*Math.pow(1.5,L.current-1),3e4);z.current=setTimeout(()=>{var n;if(null===(n=v[r])||void 0===n?void 0:n.websocket)try{let t=v[r].websocket;t&&(t.readyState===WebSocket.OPEN||t.readyState===WebSocket.CONNECTING)&&(t.onclose=null,t.onerror=null,t.close()),v[r].websocket=null}catch(t){console.error("Error closing existing websocket before reconnect:",t)}t()},o+1e3*Math.random())};return t(),()=>{z.current&&(clearTimeout(z.current),z.current=null),I.current&&(clearInterval(I.current),I.current=null)}},500);return()=>{clearTimeout(t)}},[r,k,S]),(0,i.useEffect)(()=>{let t=()=>{if(A.current&&b.current){var t;let n=A.current.clientHeight;A.current.clientWidth;let o=n-40-12;if(W("".concat(Math.max(200,o),"px")),null===(t=v[r])||void 0===t?void 0:t.fitAddon)try{requestAnimationFrame(()=>{var t,n,a;b.current&&(b.current.style.width="100%",b.current.style.height="".concat(Math.max(200,o),"px")),null===(t=v[r].fitAddon)||void 0===t||t.fit();let l=v[r].terminal;l&&(null===(n=v[r].websocket)||void 0===n?void 0:n.readyState)===WebSocket.OPEN&&(null===(a=v[r].websocket)||void 0===a||a.send(JSON.stringify({type:"resize",data:{cols:l.cols,rows:l.rows}})))})}catch(t){console.error("Error fitting terminal after height update:",t)}}},n=setTimeout(()=>{t()},100),o=null,a=()=>{o&&clearTimeout(o),o=setTimeout(()=>{t()},100)};window.addEventListener("resize",a);let l=new ResizeObserver(()=>{a()});return A.current&&l.observe(A.current),()=>{clearTimeout(n),o&&clearTimeout(o),window.removeEventListener("resize",a),l&&A.current&&(l.unobserve(A.current),l.disconnect())}},[r]),(0,o.jsxs)(m.Zb,{ref:A,className:"h-full w-full border-0 rounded-none bg-zinc-900 text-zinc-50 overflow-hidden flex flex-col",children:[(0,o.jsxs)(m.aY,{className:"p-0 flex-1 flex flex-col h-full",children:[(0,o.jsxs)("div",{className:"jsx-128035d7a41d0013 flex items-center justify-between bg-zinc-800 px-4 py-2 h-10",children:[(0,o.jsxs)("div",{className:"jsx-128035d7a41d0013 flex items-center space-x-2",children:[(0,o.jsx)("div",{className:"jsx-128035d7a41d0013 w-3 h-3 rounded-full bg-red-500"}),(0,o.jsx)("div",{className:"jsx-128035d7a41d0013 w-3 h-3 rounded-full bg-yellow-500"}),(0,o.jsx)("div",{className:"jsx-128035d7a41d0013 w-3 h-3 rounded-full bg-green-500"})]}),(0,o.jsxs)("div",{className:"jsx-128035d7a41d0013 text-sm font-medium",children:["Terminal ",r,E&&!P&&(0,o.jsx)("span",{className:"jsx-128035d7a41d0013 ml-2 text-green-400",children:"●"}),!E&&!T&&!P&&(0,o.jsx)("span",{className:"jsx-128035d7a41d0013 ml-2 text-yellow-400",children:"●"}),T&&!P&&(0,o.jsx)("span",{className:"jsx-128035d7a41d0013 ml-2 text-red-400",children:"●"}),P&&(0,o.jsx)("span",{className:"jsx-128035d7a41d0013 ml-2 text-gray-400",children:"Closing..."})]}),(0,o.jsx)("div",{className:"jsx-128035d7a41d0013 w-4"})," "]}),(0,o.jsx)("div",{ref:b,style:{padding:"6px",height:O,maxHeight:"calc(100% - 40px)"},className:"jsx-128035d7a41d0013 flex-1 w-full overflow-hidden terminal-container"})]}),(0,o.jsx)(l(),{id:"128035d7a41d0013",children:".terminal-container{user-select:text!important;-webkit-user-select:text!important;-moz-user-select:text!important;-ms-user-select:text!important;overflow:hidden!important}.terminal-container .xterm{height:100%;padding:0;overflow:hidden!important}.terminal-container .xterm-viewport{overflow-y:scroll!important;overflow-x:hidden!important;scrollbar-width:none!important;-ms-overflow-style:none!important}.terminal-container .xterm-viewport::-webkit-scrollbar{display:none!important;width:0!important;height:0!important}.terminal-container .xterm-screen{height:100%!important;-moz-user-select:text!important;-ms-user-select:text!important;user-select:text!important;-webkit-user-select:text!important;cursor:text}.terminal-container .xterm-selection{opacity:.3;z-index:3}.terminal-container .xterm-rows{overflow:auto!important;-webkit-font-variant-ligatures:none!important;-moz-font-variant-ligatures:none!important;font-variant-ligatures:none!important;white-space:pre}"})]})}}}]);